#!/bin/bash

# git-bigfile-hooks post-merge hook
# git pull/merge í›„ BigFile ê²½ë¡œ ìë™ ë™ê¸°í™”

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ì°¾ê¸°
PROJECT_ROOT="$(git rev-parse --show-toplevel)"

# ì„¤ì • íŒŒì¼ ë¡œë“œ
if [ -f "$PROJECT_ROOT/bigfile-config.sh" ]; then
    source "$PROJECT_ROOT/bigfile-config.sh"
elif [ -f "$PROJECT_ROOT/git-bigfile-hooks/config.sh" ]; then
    source "$PROJECT_ROOT/git-bigfile-hooks/config.sh"
else
    BIGFILE_DIR="BigFile"
fi

BIGFILE_PATH="$PROJECT_ROOT/$BIGFILE_DIR"

cd "$PROJECT_ROOT" || exit 0

# BigFile ë””ë ‰í† ë¦¬ê°€ ì—†ìœ¼ë©´ ì¢…ë£Œ
if [ ! -d "$BIGFILE_PATH" ]; then
    exit 0
fi

echo ""
echo "ğŸ”„ BigFile ë™ê¸°í™” í™•ì¸ ì¤‘..."

# ============================================
# 1ë‹¨ê³„: ê¹¨ì§„ symlink ì°¾ê¸°
# ============================================
broken_count=0
fixed_count=0

while IFS= read -r -d '' symlink; do
    # symlinkê°€ BigFileì„ ê°€ë¦¬í‚¤ëŠ”ì§€ í™•ì¸
    target=$(readlink "$symlink" 2>/dev/null)
    if [[ "$target" == *"$BIGFILE_DIR"* ]] || [[ "$target" == *"BigFile"* ]]; then
        if [ ! -e "$symlink" ]; then
            broken_count=$((broken_count + 1))

            # symlinkì˜ ìƒëŒ€ ê²½ë¡œ
            rel_symlink="${symlink#$PROJECT_ROOT/}"
            filename=$(basename "$symlink")
            link_dir=$(dirname "$symlink")

            echo "  âš ï¸  ê¹¨ì§„ symlink ë°œê²¬: $rel_symlink"

            # BigFileì—ì„œ ê°™ì€ ì´ë¦„ì˜ íŒŒì¼ ì°¾ê¸°
            found_file=$(find "$BIGFILE_PATH" -name "$filename" -type f 2>/dev/null | head -1)

            if [ -n "$found_file" ]; then
                # ìƒˆ BigFile ê²½ë¡œ ê³„ì‚°
                new_bigfile_path="$BIGFILE_PATH/$rel_symlink"
                new_bigfile_dir=$(dirname "$new_bigfile_path")

                mkdir -p "$new_bigfile_dir"

                if mv "$found_file" "$new_bigfile_path" 2>/dev/null; then
                    # symlink ì¬ìƒì„±
                    rm "$symlink"
                    rel_to_bigfile=$(python3 -c "import os.path; print(os.path.relpath('$new_bigfile_path', '$link_dir'))")
                    ln -s "$rel_to_bigfile" "$symlink"

                    echo "    âœ“ ë³µêµ¬ë¨: $rel_symlink"
                    fixed_count=$((fixed_count + 1))

                    # ë¹ˆ ë””ë ‰í† ë¦¬ ì •ë¦¬
                    old_dir=$(dirname "$found_file")
                    find "$old_dir" -type d -empty -delete 2>/dev/null
                fi
            fi
        fi
    fi
done < <(find "$PROJECT_ROOT" -type l -print0 2>/dev/null | grep -zv "^$BIGFILE_PATH" | grep -zv "/.git/")

# ============================================
# 2ë‹¨ê³„: ìƒˆë¡œìš´ symlinkì— ëŒ€í•œ BigFile í™•ì¸
# ============================================
# mergeë¡œ ë“¤ì–´ì˜¨ ìƒˆ symlink ì¤‘ BigFileì´ ì—†ëŠ” ê²½ìš° ê°ì§€
new_broken=0

while IFS= read -r -d '' symlink; do
    target=$(readlink "$symlink" 2>/dev/null)
    if [[ "$target" == *"$BIGFILE_DIR"* ]] || [[ "$target" == *"BigFile"* ]]; then
        if [ ! -e "$symlink" ]; then
            rel_symlink="${symlink#$PROJECT_ROOT/}"
            if [ $new_broken -eq 0 ]; then
                echo ""
                echo "  âš ï¸  ì›ê²©ì—ì„œ ê°€ì ¸ì˜¨ symlink ì¤‘ BigFileì´ ì—†ëŠ” í•­ëª©:"
            fi
            echo "    - $rel_symlink"
            new_broken=$((new_broken + 1))
        fi
    fi
done < <(find "$PROJECT_ROOT" -type l -print0 2>/dev/null | grep -zv "^$BIGFILE_PATH" | grep -zv "/.git/")

# ============================================
# ê²°ê³¼ ì¶œë ¥
# ============================================
if [ $broken_count -eq 0 ] && [ $new_broken -eq 0 ]; then
    echo "  âœ“ ëª¨ë“  BigFile symlinkê°€ ì •ìƒì…ë‹ˆë‹¤."
else
    if [ $fixed_count -gt 0 ]; then
        echo ""
        echo "âœ… ${fixed_count}ê°œì˜ symlinkê°€ ë³µêµ¬ë˜ì—ˆìŠµë‹ˆë‹¤."
    fi
    if [ $new_broken -gt 0 ]; then
        echo ""
        echo "âš ï¸  ${new_broken}ê°œì˜ symlinkì— í•´ë‹¹í•˜ëŠ” BigFileì´ ì—†ìŠµë‹ˆë‹¤."
        echo "   í•´ë‹¹ íŒŒì¼ë“¤ì€ ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì§ì ‘ ë³µì‚¬í•´ì•¼ í•©ë‹ˆë‹¤."
    fi
fi

echo ""
exit 0
