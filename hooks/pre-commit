#!/bin/bash

# git-bigfile-hooks pre-commit hook
# 10MB ì´ìƒ íŒŒì¼ ì»¤ë°‹ ì‹œ ìë™ìœ¼ë¡œ BigFile/ë¡œ ì´ë™í•˜ê³  symlink ìƒì„±

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ì°¾ê¸°
PROJECT_ROOT="$(git rev-parse --show-toplevel)"

# ì„¤ì • íŒŒì¼ ë¡œë“œ (í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë˜ëŠ” submodule ë‚´ ê¸°ë³¸ê°’)
if [ -f "$PROJECT_ROOT/bigfile-config.sh" ]; then
    source "$PROJECT_ROOT/bigfile-config.sh"
elif [ -f "$PROJECT_ROOT/git-bigfile-hooks/config.sh" ]; then
    source "$PROJECT_ROOT/git-bigfile-hooks/config.sh"
else
    # ê¸°ë³¸ê°’
    MAX_SIZE_MB=10
    BIGFILE_DIR="BigFile"
    CREATE_SYMLINKS=true
fi

MAX_SIZE_BYTES=$((MAX_SIZE_MB * 1024 * 1024))

echo "Checking file sizes before commit..."

# ìŠ¤í…Œì´ì§•ëœ íŒŒì¼ ì¤‘ í¬ê¸°ê°€ í° íŒŒì¼ ì°¾ê¸°
large_files=()
total_files=0

cd "$PROJECT_ROOT" || exit 1

for file in $(git diff --cached --name-only --diff-filter=ACM); do
    if [ -f "$file" ] && [ ! -L "$file" ]; then
        total_files=$((total_files + 1))
        file_size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)

        if [ $? -eq 0 ] && [ "$file_size" -gt "$MAX_SIZE_BYTES" ]; then
            file_size_mb=$(echo "scale=2; $file_size / 1048576" | bc)
            large_files+=("$file:${file_size_mb}")
        fi
    fi
done

# í° íŒŒì¼ì´ ë°œê²¬ë˜ë©´ ìë™ìœ¼ë¡œ ì´ë™
if [ ${#large_files[@]} -gt 0 ]; then
    echo ""
    echo "âš ï¸  ë°œê²¬: ${#large_files[@]}ê°œì˜ í° íŒŒì¼(${MAX_SIZE_MB}MB ì´ìƒ)ì´ ì»¤ë°‹ì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
    echo ""

    for item in "${large_files[@]}"; do
        file="${item%%:*}"
        size="${item##*:}"
        echo "  - $file (${size}MB)"
    done

    echo ""
    echo "ğŸ”„ ìë™ìœ¼ë¡œ $BIGFILE_DIR/ ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•©ë‹ˆë‹¤..."
    echo ""

    # í° íŒŒì¼ë“¤ì„ BigFile/ë¡œ ì´ë™
    for item in "${large_files[@]}"; do
        file="${item%%:*}"

        if [ -f "$file" ]; then
            # ëª©ì ì§€ ê²½ë¡œ ìƒì„±
            dest_file="$BIGFILE_DIR/$file"
            dest_dir=$(dirname "$dest_file")

            # ëª©ì ì§€ ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p "$dest_dir"

            # íŒŒì¼ ì´ë™
            if mv "$file" "$dest_file"; then
                echo "  âœ“ ì´ë™ ì™„ë£Œ: $file â†’ $dest_file"

                # gitì—ì„œ ì œê±° (staged ìƒíƒœ í•´ì œ)
                git rm --cached "$file" 2>/dev/null

                # symlink ìƒì„± (ì„¤ì •ì— ë”°ë¼)
                if [ "$CREATE_SYMLINKS" = true ]; then
                    original_dir=$(dirname "$file")
                    mkdir -p "$original_dir"

                    # ìƒëŒ€ ê²½ë¡œë¡œ symlink ìƒì„±
                    rel_to_bigfile=$(python3 -c "import os.path; print(os.path.relpath('$dest_file', '$original_dir'))")

                    if ln -s "$rel_to_bigfile" "$file"; then
                        echo "  ğŸ”— Symlink ìƒì„±: $file â†’ $rel_to_bigfile"

                        # symlinkë¥¼ stagingì— ì¶”ê°€
                        git add "$file"
                    fi
                fi
            else
                echo "  âœ— ì´ë™ ì‹¤íŒ¨: $file"
            fi
        fi
    done

    echo ""
    echo "âœ… í° íŒŒì¼ì´ $BIGFILE_DIR/ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤."
    echo "   ($BIGFILE_DIR/* ì€ .gitignoreì— ë“±ë¡ë˜ì–´ ìˆì–´ Gitì—ì„œ ì¶”ì ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)"
    if [ "$CREATE_SYMLINKS" = true ]; then
        echo "   (symlinkëŠ” Gitì—ì„œ ì¶”ì ë©ë‹ˆë‹¤)"
    fi
    echo ""
fi

# ë‚˜ë¨¸ì§€ íŒŒì¼ í¬ê¸° í™•ì¸
remaining_files=0
for file in $(git diff --cached --name-only --diff-filter=ACM); do
    if [ -f "$file" ]; then
        remaining_files=$((remaining_files + 1))
    fi
done

echo "âœ“ ì»¤ë°‹ ì¤€ë¹„ ì™„ë£Œ ($remaining_files files)"
exit 0
