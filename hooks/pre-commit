#!/bin/bash

# git-bigfile-hooks pre-commit hook
# 10MB ì´ìƒ íŒŒì¼ ì»¤ë°‹ ì‹œ ìë™ìœ¼ë¡œ BigFile/ë¡œ ì´ë™í•˜ê³  symlink ìƒì„±
# íŒŒì¼ ì´ë™/ì´ë¦„ë³€ê²½ ì‹œ BigFile ê²½ë¡œ ìë™ ë™ê¸°í™”

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ì°¾ê¸°
PROJECT_ROOT="$(git rev-parse --show-toplevel)"

# ì„¤ì • íŒŒì¼ ë¡œë“œ (í”„ë¡œì íŠ¸ ë£¨íŠ¸ ë˜ëŠ” submodule ë‚´ ê¸°ë³¸ê°’)
if [ -f "$PROJECT_ROOT/bigfile-config.sh" ]; then
    source "$PROJECT_ROOT/bigfile-config.sh"
elif [ -f "$PROJECT_ROOT/git-bigfile-hooks/config.sh" ]; then
    source "$PROJECT_ROOT/git-bigfile-hooks/config.sh"
else
    # ê¸°ë³¸ê°’
    MAX_SIZE_MB=10
    BIGFILE_DIR="BigFile"
    CREATE_SYMLINKS=true
fi

BIGFILE_PATH="$PROJECT_ROOT/$BIGFILE_DIR"
MAX_SIZE_BYTES=$((MAX_SIZE_MB * 1024 * 1024))

cd "$PROJECT_ROOT" || exit 1

echo "Checking file sizes before commit..."

# ============================================
# 0ë‹¨ê³„: ì´ë™/ì´ë¦„ë³€ê²½ëœ symlinkì˜ BigFile ê²½ë¡œ ë™ê¸°í™”
# ============================================
sync_renamed_symlinks() {
    local synced=0

    # git statusì—ì„œ renamed íŒŒì¼ ì°¾ê¸° (R ìƒíƒœ)
    while IFS=$'\t' read -r status old_path new_path; do
        # Rë¡œ ì‹œì‘í•˜ëŠ” ìƒíƒœë§Œ ì²˜ë¦¬
        if [[ "$status" == R* ]]; then
            # ìƒˆ ê²½ë¡œê°€ symlinkì´ê³  BigFileì„ ê°€ë¦¬í‚¤ëŠ”ì§€ í™•ì¸
            if [ -L "$new_path" ]; then
                target=$(readlink "$new_path" 2>/dev/null)
                if [[ "$target" == *"$BIGFILE_DIR"* ]] || [[ "$target" == *"BigFile"* ]]; then
                    # BigFile ë‚´ë¶€ì˜ ê¸°ì¡´ ê²½ë¡œ
                    old_bigfile_path="$BIGFILE_PATH/$old_path"
                    new_bigfile_path="$BIGFILE_PATH/$new_path"

                    if [ -f "$old_bigfile_path" ]; then
                        echo ""
                        echo "ğŸ”„ Symlink ì´ë™ ê°ì§€: $old_path â†’ $new_path"

                        # BigFile ë‚´ë¶€ ê²½ë¡œë„ ì´ë™
                        new_bigfile_dir=$(dirname "$new_bigfile_path")
                        mkdir -p "$new_bigfile_dir"

                        if mv "$old_bigfile_path" "$new_bigfile_path"; then
                            echo "  âœ“ BigFile ê²½ë¡œ ë™ê¸°í™”: $BIGFILE_DIR/$old_path â†’ $BIGFILE_DIR/$new_path"

                            # symlink ì¬ìƒì„± (ìƒëŒ€ ê²½ë¡œ)
                            rm "$new_path"
                            original_dir=$(dirname "$new_path")
                            mkdir -p "$original_dir"
                            rel_to_bigfile=$(python3 -c "import os.path; print(os.path.relpath('$new_bigfile_path', '$original_dir'))")
                            ln -s "$rel_to_bigfile" "$new_path"
                            git add "$new_path"

                            echo "  âœ“ Symlink ì¬ìƒì„±ë¨"
                            synced=$((synced + 1))

                            # ë¹ˆ ë””ë ‰í† ë¦¬ ì •ë¦¬
                            old_bigfile_dir=$(dirname "$old_bigfile_path")
                            find "$old_bigfile_dir" -type d -empty -delete 2>/dev/null
                        fi
                    fi
                fi
            fi
        fi
    done < <(git diff --cached --name-status -M 2>/dev/null | grep "^R")

    if [ $synced -gt 0 ]; then
        echo ""
        echo "âœ… ${synced}ê°œì˜ BigFile ê²½ë¡œê°€ ë™ê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤."
        echo ""
    fi
}

# symlink ì´ë™ ë™ê¸°í™” ì‹¤í–‰
sync_renamed_symlinks

# ============================================
# 1ë‹¨ê³„: ìŠ¤í…Œì´ì§•ëœ íŒŒì¼ ì¤‘ í¬ê¸°ê°€ í° íŒŒì¼ ì°¾ê¸°
# ============================================
large_files=()
total_files=0

# -z ì˜µì…˜ìœ¼ë¡œ NULL êµ¬ë¶„ì ì‚¬ìš©í•˜ì—¬ ê³µë°±ì´ ìˆëŠ” íŒŒì¼ëª… ì²˜ë¦¬
while IFS= read -r -d '' file; do
    if [ -f "$file" ] && [ ! -L "$file" ]; then
        total_files=$((total_files + 1))
        file_size=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)

        if [ $? -eq 0 ] && [ "$file_size" -gt "$MAX_SIZE_BYTES" ]; then
            file_size_mb=$(echo "scale=2; $file_size / 1048576" | bc)
            large_files+=("$file:${file_size_mb}")
        fi
    fi
done < <(git diff --cached --name-only -z --diff-filter=ACMT)

# í° íŒŒì¼ì´ ë°œê²¬ë˜ë©´ ìë™ìœ¼ë¡œ ì´ë™
if [ ${#large_files[@]} -gt 0 ]; then
    echo ""
    echo "âš ï¸  ë°œê²¬: ${#large_files[@]}ê°œì˜ í° íŒŒì¼(${MAX_SIZE_MB}MB ì´ìƒ)ì´ ì»¤ë°‹ì— í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤."
    echo ""

    for item in "${large_files[@]}"; do
        file="${item%%:*}"
        size="${item##*:}"
        echo "  - $file (${size}MB)"
    done

    echo ""
    echo "ğŸ”„ ìë™ìœ¼ë¡œ $BIGFILE_DIR/ ë””ë ‰í† ë¦¬ë¡œ ì´ë™í•©ë‹ˆë‹¤..."
    echo ""

    # í° íŒŒì¼ë“¤ì„ BigFile/ë¡œ ì´ë™
    for item in "${large_files[@]}"; do
        file="${item%%:*}"

        if [ -f "$file" ]; then
            # ëª©ì ì§€ ê²½ë¡œ ìƒì„±
            dest_file="$BIGFILE_DIR/$file"
            dest_dir=$(dirname "$dest_file")

            # ëª©ì ì§€ ë””ë ‰í† ë¦¬ ìƒì„±
            mkdir -p "$dest_dir"

            # íŒŒì¼ ì´ë™
            if mv "$file" "$dest_file"; then
                echo "  âœ“ ì´ë™ ì™„ë£Œ: $file â†’ $dest_file"

                # gitì—ì„œ ì œê±° (staged ìƒíƒœ í•´ì œ)
                git rm --cached "$file" 2>/dev/null

                # symlink ìƒì„± (ì„¤ì •ì— ë”°ë¼)
                if [ "$CREATE_SYMLINKS" = true ]; then
                    original_dir=$(dirname "$file")
                    mkdir -p "$original_dir"

                    # ìƒëŒ€ ê²½ë¡œë¡œ symlink ìƒì„±
                    rel_to_bigfile=$(python3 -c "import os.path; print(os.path.relpath('$dest_file', '$original_dir'))")

                    if ln -s "$rel_to_bigfile" "$file"; then
                        echo "  ğŸ”— Symlink ìƒì„±: $file â†’ $rel_to_bigfile"

                        # symlinkë¥¼ stagingì— ì¶”ê°€
                        git add "$file"
                    fi
                fi
            else
                echo "  âœ— ì´ë™ ì‹¤íŒ¨: $file"
            fi
        fi
    done

    echo ""
    echo "âœ… í° íŒŒì¼ì´ $BIGFILE_DIR/ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ë˜ì—ˆìŠµë‹ˆë‹¤."
    echo "   ($BIGFILE_DIR/* ì€ .gitignoreì— ë“±ë¡ë˜ì–´ ìˆì–´ Gitì—ì„œ ì¶”ì ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤)"
    if [ "$CREATE_SYMLINKS" = true ]; then
        echo "   (symlinkëŠ” Gitì—ì„œ ì¶”ì ë©ë‹ˆë‹¤)"
    fi
    echo ""
fi

# ë‚˜ë¨¸ì§€ íŒŒì¼ í¬ê¸° í™•ì¸
remaining_files=0
while IFS= read -r -d '' file; do
    if [ -f "$file" ]; then
        remaining_files=$((remaining_files + 1))
    fi
done < <(git diff --cached --name-only -z --diff-filter=ACMT)

echo "âœ“ ì»¤ë°‹ ì¤€ë¹„ ì™„ë£Œ ($remaining_files files)"
exit 0
